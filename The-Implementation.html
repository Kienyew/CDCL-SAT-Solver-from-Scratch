<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Implementation - CDCL From Scratch in Python</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="CDCL-SAT-Solver-from-Scratch.html">CDCL SAT Solver from Scratch</a></li><li class="chapter-item expanded "><a href="The-Theory.html"><strong aria-hidden="true">1.</strong> The Theory</a></li><li class="chapter-item expanded "><a href="The-Implementation.html" class="active"><strong aria-hidden="true">2.</strong> The Implementation</a></li><li class="chapter-item expanded "><a href="Two-Watched-Literals.html"><strong aria-hidden="true">3.</strong> Advanced: Two-Watched Literals</a></li><li class="chapter-item expanded "><a href="Conclusion.html"><strong aria-hidden="true">4.</strong> Conclusion</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CDCL From Scratch in Python</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-implementation"><a class="header" href="#the-implementation">The Implementation</a></h1>
<p>In the code, I frequently use the <a href="https://docs.python.org/3/library/dataclasses.html">dataclass</a> from standard library. Basically it is just a shorthand for defining a small class storing only few properties. It saves the code for us to define <code>__init__</code> function, and better default string representation:</p>
<pre><code class="language-python">from dataclasses import dataclass

@dataclass
class Animal:
    name: str
    kind: str
    age: int

print(Animal('Pikachu', 'Cat', 3))  
# output: Animal(name='Pikachu', kind='Cat', age=3)
</code></pre>
<p>It becomes clear on what a class stores.</p>
<h2 id="structures"><a class="header" href="#structures">Structures</a></h2>
<p>Next, we implement the class for</p>
<ul>
<li>Literal = <code>var + negation?</code></li>
<li>Clause = <code>List[Literal]</code></li>
<li>Formula = <code>List[Clause]</code></li>
</ul>
<p>Instead of representing them with primitive types, put them into individual classes are easier to read in my opinion.</p>
<p>The variables are represented as integer. First import all the standard libraries we used:</p>
<pre><code class="language-python">import sys
import random
from pprint import pprint
from dataclasses import dataclass
from typing import List, Set, Tuple, Optional, Iterator
</code></pre>
<h3 id="literal"><a class="header" href="#literal">Literal</a></h3>
<pre><code class="language-python"># frozen to be hashable
@dataclass(frozen=True)
class Literal:
    variable: int
    negation: bool

    def __repr__(self):
        if self.negation:
            return 'Â¬' + str(self.variable)
        else:
            return str(self.variable)

	def neg(self) -&gt; 'Literal':
        &quot;&quot;&quot;
        Return the negation of this literal.
        &quot;&quot;&quot;
        return Literal(self.variable, not self.negation)
</code></pre>
<h3 id="clause"><a class="header" href="#clause">Clause</a></h3>
<p>The clause is just a list of literals.</p>
<pre><code class="language-python">@dataclass
class Clause:
    literals: List[Literal]

    def __repr__(self):
        return 'â¨'.join(map(str, self.literals))

    def __iter__(self) -&gt; Iterator[Literal]:
        return iter(self.literals)

    def __len__(self):
        return len(self.literals)
</code></pre>
<h3 id="formula"><a class="header" href="#formula">Formula</a></h3>
<p>The formula is just a list of clauses. We remove duplicate literals like \((1â¨ 1 â¨ 2)\) and cache the variables in the constructor.</p>
<pre><code class="language-python">@dataclass
class Formula:
    clauses: List[Clause]
    __variables: Set[int]

    def __init__(self, clauses: List[Clause]):
        &quot;&quot;&quot;
        Remove duplicate literals in clauses.
        &quot;&quot;&quot;
        self.clauses = []
        self.__variables = set()
        for clause in clauses:
            self.clauses.append(Clause(list(set(clause))))
            for lit in clause:
                var = lit.variable
                self.__variables.add(var)

    def variables(self) -&gt; Set[int]:
        &quot;&quot;&quot;
        Return the set of variables contained in this formula.
        &quot;&quot;&quot;
        return self.__variables

    def __repr__(self):
        return ' â§ '.join(f'({clause})' for clause in self.clauses)

    def __iter__(self) -&gt; Iterator[Clause]:
        return iter(self.clauses)

    def __len__(self):
        return len(self.clauses)
</code></pre>
<h3 id="assignment"><a class="header" href="#assignment">Assignment</a></h3>
<p><code>Assignment</code> class represent one assignment to a variable. It contains</p>
<ul>
<li>The value (<code>True</code> or <code>False</code>) of what the variable assigned to.</li>
<li>The optional antecedent of this assignment. The antecedent is the clause that forced this assignment due to unit constraint. If this assignment is due to decision (guessing), then antecedent is <code>None</code>.</li>
<li><code>dl</code> - The decision level of this assignment.</li>
</ul>
<pre><code class="language-python">@dataclass
class Assignment:
    value: bool
    antecedent: Optional[Clause]
    dl: int  # decision level
</code></pre>
<img src="./images/image-20230122150424569.png" alt="image-20230122150424569" style="zoom: 67%;" />
<p>An instance of <code>Assignment</code> contains the information in the red circle.</p>
<ul>
<li><code>value</code> = 0 (False)</li>
<li><code>antecedent</code> = \(\omega_2\)</li>
<li><code>dl</code> = 5</li>
</ul>
<h3 id="assignments"><a class="header" href="#assignments">Assignments</a></h3>
<p><code>Assignments</code> is the partial assignments of variables, maps an <code>int</code> to <code>Assignment</code>. An efficient representation of assignments should be stored in a list trail, which improve the backtrack efficiency.</p>
<p>I also added a utility method <code>value</code> here.</p>
<pre><code class="language-python">class Assignments(dict):
    &quot;&quot;&quot;
    The assignments, also stores the current decision level.
    &quot;&quot;&quot;
    def __init__(self):
        super().__init__()

        # the decision level
        self.dl = 0

    def value(self, literal: Literal) -&gt; bool:
        &quot;&quot;&quot;
        Return the value of the literal with respect the current assignments.
        &quot;&quot;&quot;
        if literal.negation:
            return not self[literal.variable].value
        else:
            return self[literal.variable].value

    def assign(self, variable: int, value: bool, antecedent: Optional[Clause]):
        self[variable] = Assignment(value, antecedent, self.dl)

    def unassign(self, variable: int):
        self.pop(variable)

    def satisfy(self, formula: Formula) -&gt; bool:
        &quot;&quot;&quot;
        Check whether the assignments actually satisfies the formula. 
        &quot;&quot;&quot;
        for clause in formula:
            if True not in [self.value(lit) for lit in clause]:
                return False

        return True
</code></pre>
<h2 id="main-procedures"><a class="header" href="#main-procedures">Main Procedures</a></h2>
<p>Having defined all the needed classes, now are the hard parts. We will implement the full CDCL solver here.</p>
<p>The CDCL algorithm generally follows the structure:</p>
<p><img src="./images/image-20230123195153774.png" alt="image-20230123195153774" />Note that \(\nu\) above is the partial assignments, which represented by <code>assignments</code> in our code.</p>
<p>Translate it into Python code:</p>
<h3 id="cdcl_solve"><a class="header" href="#cdcl_solve"><code>cdcl_solve</code></a></h3>
<p>We return the <code>learnt_clause</code> from <code>conflict_analysis</code>, and add the <code>learnt_clause</code> to the formula afterward, and return the reason as well as the clause that are the cause of the reason from <code>unit_propagation</code>.</p>
<pre><code class="language-python">def cdcl_solve(formula: Formula) -&gt; Optional[Assignments]:
    &quot;&quot;&quot;
    Solve the CNF formula.

    If SAT, return the assignments.
    If UNSAT, return None.
    &quot;&quot;&quot;
    assignments = Assignments()
    
    # First, do unit propagation to assign the initial unit clauses 
    reason, clause = unit_propagation(formula, assignments)
    if reason == 'conflict':
        return None

    while not all_variables_assigned(formula, assignments):
        var, val = pick_branching_variable(formula, assignments)
        assignments.dl += 1
        assignments.assign(var, val, antecedent=None)
        while True:
            reason, clause = unit_propagation(formula, assignments)
            if reason != 'conflict':
                # no conflict after unit propagation, we back
                # to the decision (guessing) step
                break
                
            b, learnt_clause = conflict_analysis(clause, assignments)
            if b &lt; 0:
                return None
            
            add_learnt_clause(formula, learnt_clause)
            backtrack(assignments, b)
            assignments.dl = b

            # The learnt clause must be a unit clause, so the
            # next step must again be unit progagation

    return assignments
</code></pre>
<p>Next, we implement all the functions mentioned in <code>cdcl_solve</code>. Starts from the easy to hard.</p>
<h3 id="add_learnt_clause"><a class="header" href="#add_learnt_clause"><code>add_learnt_clause</code></a></h3>
<p>&quot;Learning&quot; a clause is just as simple as adding it to the formula.</p>
<pre><code class="language-python">def add_learnt_clause(formula: Formula, clause: Clause):
    formula.clauses.append(clause)
</code></pre>
<h3 id="all_variables_assigned"><a class="header" href="#all_variables_assigned"><code>all_variables_assigned</code></a></h3>
<p>As simple as it is:</p>
<pre><code class="language-python">def all_variables_assigned(formula: Formula, assignments: Assignments) -&gt; bool:
    return len(formula.variables()) == len(assignments)
</code></pre>
<h3 id="pick_branching_variable"><a class="header" href="#pick_branching_variable"><code>pick_branching_variable</code></a></h3>
<p>Choose the next decision variable and its value based on our branching heuristic - no heuristic.</p>
<p>We randomly choose a variable in unassigned variables and randomly choose a value.</p>
<pre><code class="language-python">def pick_branching_variable(formula: Formula, assignments: Assignments) -&gt; Tuple[int, bool]:
    unassigned_vars = [var for var in formula.variables() if var not in assignments]
    var = random.choice(unassigned_vars)
    val = random.choice([True, False])
    return (var, val)
</code></pre>
<h3 id="backtrack"><a class="header" href="#backtrack"><code>backtrack</code></a></h3>
<p>This function backtracks to decision level \(b\), removing all the assignment of variables with decision level \(\gt b\).</p>
<pre><code class="language-python">def backtrack(assignments: Assignments, b: int):
    to_remove = []
    for var, assignment in assignments.items():
        if assignment.dl &gt; b:
            to_remove.append(var)
            
	for var in to_remove:
        assignments.pop(var)
</code></pre>
<h3 id="unit_propagation"><a class="header" href="#unit_propagation"><code>unit_propagation</code></a></h3>
<p>Next is unit propagation. We detect conflict or unit clause in this function, and return the reason and the corresponding clause.</p>
<pre><code class="language-python">def clause_status(clause: Clause, assignments: Assignments) -&gt; str:
    &quot;&quot;&quot;
    Return the status of the clause with respect to the assignments.

    There are 4 possible status of a clause:
      1. Unit - All but one literal are assigned False
      2. Unsatisfied - All literals are assigned False
      3. Satisfied - All literals are assigned True
      4. Unresolved - Neither unit, satisfied nor unsatisfied
    &quot;&quot;&quot;
    values = []
    for literal in clause:
        if literal.variable not in assignments:
            values.append(None)
        else:
            values.append(assignments.value(literal))

    if True in values:
        return 'satisfied'
    elif values.count(False) == len(values):
        return 'unsatisfied'
    elif values.count(False) == len(values) - 1:
        return 'unit'
    else:
        return 'unresolved'


def unit_propagation(formula: Formula, assignments: Assignments) -&gt; Tuple[str, Optional[Clause]]:
    # finish is set to True if no unit and conflict clause found in one iteration
    finish = False
    while not finish:
        finish = True
        for clause in formula:
            status = clause_status(clause, assignments)
            if status == 'unresolved' or status == 'satisfied':
                continue
            elif status == 'unit':
                # select the literal to propagate
                literal = next(literal for literal in clause if literal.variable not in assignments)
                var = literal.variable
                val = not literal.negation

                # assign the variable according to unit rule
                assignments.assign(var, val, antecedent=clause)
                finish = False
            else:
                # conflict
                return ('conflict', clause)

    return ('unresolved', None)
</code></pre>
<h3 id="conflict_analysis"><a class="header" href="#conflict_analysis"><code>conflict_analysis</code></a></h3>
<p><code>conflict_analysis</code> finds the the backtrack level and the newly learnt clause, which comes from the first UIP cut.</p>
<p>It follows the formula (see the section above: <a href="The-Theory.html#exploiting-structure-with-uips">Exploiting Structure with UIPs</a>):
\[
w_L^{d,i} = \begin{cases}
\alpha(\kappa),&amp;i=0 \\
w_L^{d,i-1} \odot \alpha(l).&amp;i\ne 0 â§ \xi(w_L^{d,i-1},l,d) = 1 \\
w_L^{d,i-1},&amp; i\ne 0 â§ \sigma(w_L^{d,i-1},d) = 1
\end{cases}
\]
We first define the resolution operation, then the main <code>conflict_analysis</code> function:</p>
<pre><code class="language-python">def resolve(a: Clause, b: Clause, x: int) -&gt; Clause:
    &quot;&quot;&quot;
    The resolution operation
    &quot;&quot;&quot;
    result = set(a.literals + b.literals) - {Literal(x, True), Literal(x, False)}
    result = list(result)
    return Clause(result)


def conflict_analysis(clause: Clause, assignments: Assignments) -&gt; Tuple[int, Clause]:
    if assignments.dl == 0:
        return (-1, None)
 
    # literals with current decision level
    literals = [literal for literal in clause if assignments[literal.variable].dl == assignments.dl]
    while len(literals) != 1:
        # implied literals
        literals = filter(lambda lit: assignments[lit.variable].antecedent != None, literals)

        # select any literal that meets the criterion
        literal = next(literals)
        antecedent = assignments[literal.variable].antecedent
        clause = resolve(clause, antecedent, literal.variable)

        # literals with current decision level
        literals = [literal for literal in clause if assignments[literal.variable].dl == assignments.dl]

    # out of the loop, `clause` is now the new learnt clause
    # compute the backtrack level b (second largest decision level)
    decision_levels = sorted(set(assignments[literal.variable].dl for literal in clause))
    if len(decision_levels) &lt;= 1:
        return 0, clause
    else:
        return decision_levels[-2], clause
</code></pre>
<h3 id="dimacs-cnf"><a class="header" href="#dimacs-cnf">DIMACS CNF</a></h3>
<p>The <a href="https://people.sc.fsu.edu/~jburkardt/data/cnf/cnf.html">DIMACS CNF</a> format is a textual representation of a formula in conjunctive normal form.</p>
<p>For example, the formula \((1â¨2â¨Â¬ 3) â§ (Â¬ 2 â§ 3)\) can be encoded as:</p>
<pre><code>p cnf 3 2
1 2 -3 0
-2 3 0
</code></pre>
<h4 id="parse_dimacs_cnf"><a class="header" href="#parse_dimacs_cnf"><code>parse_dimacs_cnf</code></a></h4>
<p>Here is the code to parse DIMACS CNF file to a <code>Formula</code>, you can take it as given:</p>
<pre><code class="language-python">def parse_dimacs_cnf(content: str) -&gt; Formula:
    &quot;&quot;&quot;
    parse the DIMACS cnf file format into corresponding Formula.
    &quot;&quot;&quot;
    clauses = [Clause([])]
    for line in content.splitlines():
        tokens = line.split()
        if len(tokens) != 0 and tokens[0] not in (&quot;p&quot;, &quot;c&quot;):
            for tok in tokens:
                lit = int(tok)
                if lit == 0:
                    clauses.append(Clause([]))
                else:
                    var = abs(lit)
                    neg = lit &lt; 0
                    clauses[-1].literals.append(Literal(var, neg))

    if len(clauses[-1]) == 0:
        clauses.pop()

    return Formula(clauses)
</code></pre>
<p>and we have just successfully implemented a CDCL solver in less than 300 lines of code, try it out:</p>
<pre><code class="language-python">if __name__ == '__main__':
    # you might comment it to get inconsistent execution time
    random.seed(5201314)

    if len(sys.argv) != 2:
        print('Provide one DIMACS cnf filename as argument.')
        sys.exit(1)
        
    dimacs_cnf = open(sys.argv[1]).read()
    formula = parse_dimacs_cnf(dimacs_cnf)
    result = cdcl_solve(formula)
    if result:
        assert result.satisfy(formula)
        print('Formula is SAT with assignments:')
        assignments = {var: assignment.value for var, assignment in result.items()}
        pprint(assignments)
    else:
        print('Formula is UNSAT.')
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="The-Theory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="Two-Watched-Literals.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="The-Theory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="Two-Watched-Literals.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
